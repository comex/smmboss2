<style>
#diagram {
    border: 1px solid black;
    width: 500px;
    height: 500px;
}
</style>
<body>
<form id="form">
<input type="radio" name="mode" id="rsvg" value="svg" checked><label for="rsvg"> SVG</label> (<input type="checkbox" id="reuse"><label for="reuse"> Reuse elements)</label><br>
<input type="radio" name="mode" id="rcanvas" value="canvas"><label for="rcanvas"> Canvas</label><br>
<input type="range" name="numLinesUntransformed" min="0" max="100" step="0.1" value="10" style="width: 500px" />
</form>
<div id="fps">0 fps</div>
<div id="target"></div>
</body>
<script>
let colors = ['red', 'green', 'yellow', 'blue', 'pink'];
let linesPerColor = 1000;
let svgNS = 'http://www.w3.org/2000/svg';
class Svg {
    constructor() {
        document.getElementById('target').innerHTML = '<svg id="diagram" />';
        this.svg = document.getElementById('diagram');
        this.lines = [];
        this.reuseElements = false;
    }
    startFrame() {
        this.drawnLines = 0;
        this.didReuseElements = this.reuseElements;
        this.reuseElements = window.form.reuse.checked;
        if (!this.didReuseElements) {
            this.lines = [];
            this.svg.innerHTML = '';
        }
    }
    createLine(lineIdx) {
        let line = document.createElementNS(svgNS, 'line');
        this.svg.appendChild(line);
        line.setAttribute('stroke', colors[((lineIdx / linesPerColor) | 0) % colors.length]);
        line.setAttribute('stroke-width', 4);
        return line;
    }
    drawLine(x1, y1, x2, y2) {
    let lineIdx = this.drawnLines++;
        let line;
        if (this.reuseElements) {
            line = this.lines[lineIdx];
            if (line === undefined) {
                line = this.lines[lineIdx] = this.createLine(lineIdx);
            }
        } else {
            line = this.createLine(lineIdx);
        }
        line.setAttribute('x1', x1);
        line.setAttribute('y1', y1);
        line.setAttribute('x2', x2);
        line.setAttribute('y2', y2);
    }
    endFrame() {
        while (this.lines.length > this.drawnLines) {
            let line = this.lines.pop();
            line.parentNode.removeChild(line);
        }
    }
}

class Canvas {
    constructor() {
        document.getElementById('target').innerHTML = '<canvas id="diagram" />';
        this.canvas = document.getElementById('diagram');
        this.ctx = this.canvas.getContext('2d');
    }
    startFrame() {
        this.dpr = devicePixelRatio;
        this.canvas.width = this.canvas.height = 500 * this.dpr;
        this.ctx.clearRect(0, 0, 500 * this.dpr, 500 * this.dpr);
        this.drawnPaths = 0;
        this.beginPath();
    }
    beginPath() {
        this.pathLines = 0;
        this.ctx.strokeStyle = colors[this.drawnPaths % colors.length];
        this.ctx.lineWidth = 4 * this.dpr;
        this.ctx.beginPath();
    }
    drawLine(x1, y1, x2, y2) {
        this.ctx.moveTo(x1 * this.dpr, y1 * this.dpr);
        this.ctx.lineTo(x2 * this.dpr, y2 * this.dpr);
        if (++this.pathLines == linesPerColor) {
            this.endPath();
            this.beginPath();
        }
    }
    endPath() {
        this.ctx.stroke();
        this.drawnPaths++;
    }
    endFrame() {
        this.endPath();
    }
}

let numLines = 1000;
let drawnFrames = 0;
let xOffset = 0;
let yOffset = 0;
let curMode = null;
let target = null;
let form = document.getElementById('form');

function draw() {
    let mode = form.mode.value;
    if (mode !== curMode) {
        curMode = mode;
        target = mode == 'svg' ? new Svg : new Canvas;
    }
    numLines = (form.numLinesUntransformed.value ** 3) | 0;
    target.startFrame();
    let divisor = Math.sqrt(numLines) | 0;
    for (let i = 0; i < numLines; i++) {
        let xPart = i % divisor;
        let yPart = (i / divisor) | 0;

        let x1 = (xPart * 14 + xOffset) % 580 - 80;
        let y1 = (yPart * 13 + yOffset) % 580 - 80;

        let x2 = x1 + 50;
        let y2 = y1 + (i % 41);
        target.drawLine(x1, y1, x2, y2);
    }
    target.endFrame();
    drawnFrames++;
    xOffset = (xOffset + 1) % 580;
    requestAnimationFrame(draw);
}
draw();
let hz = 3;
let lastTime = new Date().getTime();
setInterval(() => {
    let newTime = new Date().getTime();
    let timeSinceLast = newTime - lastTime;
    lastTime = newTime;
    document.getElementById('fps').innerHTML = `${Math.round(drawnFrames / (timeSinceLast / 1000) * 10) / 10} fps for ${numLines} lines at devicePixelRatio ${devicePixelRatio}`;
    drawnFrames = 0;
}, 1000 / hz);
</script>
